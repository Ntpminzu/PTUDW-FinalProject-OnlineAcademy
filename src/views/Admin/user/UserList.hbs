{{#section "styles" append=true}}
<link rel="stylesheet" href="/Adminn.css">
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const btn = document.getElementById("roleDropdownBtn");
    const menu = document.getElementById("roleDropdownMenu");
    const searchInput = document.querySelector(".search-box input");
    const rows = document.querySelectorAll(".user-table tbody tr");

    let currentRole = "all";

    if (!btn || !menu || !searchInput) return;

    // Dropdown toggle
    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      menu.classList.toggle("show");
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
      if (!btn.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.remove("show");
      }
    });

    // Role filter
    menu.querySelectorAll("li").forEach((item) => {
      item.addEventListener("click", () => {
        const selectedRole = item.textContent.trim();
        currentRole = item.dataset.role;
        btn.innerHTML = `<i class="bi bi-person-badge"></i> ${selectedRole} <i class="bi bi-caret-down-fill"></i>`;
        menu.classList.remove("show");
        applyFilters();
      });
    });

    // Search filter
    searchInput.addEventListener("input", () => {
      applyFilters();
    });

    // 🔥 Kết hợp lọc role + tìm kiếm
    function applyFilters() {
      const keyword = searchInput.value.trim().toLowerCase();

      rows.forEach((row) => {
        const text = row.textContent.toLowerCase();
        const roleText = row.querySelector(".status")?.textContent.trim().toLowerCase() || "";
        const matchKeyword = text.includes(keyword);
        const matchRole = currentRole === "all" || roleText.includes(currentRole === "0" ? "admin" : currentRole === "1" ? "instructor" : "student");
        row.style.display = matchKeyword && matchRole ? "" : "none";
      });
    }
  });
</script>

{{/section}}

<div class="user-container">
  <h2>User Management</h2>

  <div class="toolbar">
    <div class="filters">
      <div class="search-box">
        <i class="bi bi-search"></i>
        <input type="text" placeholder="Search">
      </div>
      <div class="dropdown">
        <button class="btn-filter" id="roleDropdownBtn">
          <i class="bi bi-person-badge"></i> Role
          <i class="bi bi-caret-down-fill"></i>
        </button>
        <ul class="dropdown-menu" id="roleDropdownMenu">
          <li data-role="all">All</li>
          <li data-role="0">Admin</li>
          <li data-role="1">Instructor</li>
          <li data-role="2">Student</li>
        </ul>
      </div>

    </div>
    <a href="/admin/user/add">
      <button class="btn-add"><i class="bi bi-plus-circle"></i> Add User</button>
    </a>
  </div>

  <div class="table-wrapper">
    <table class="user-table">
      <thead>
        <tr>
          <th>Full Name</th>
          <th>Email</th>
          <th>Username</th>
          <th>Role</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {{#each users}}
        <tr>
          <td>
            <div class="user-info">
              <span>{{Fullname}}</span>
            </div>
          </td>
          <td>
            <div class="user-info">
              <span>{{Email}}</span>
            </div>
          </td>
          <td>
            <div class="user-info">
              <span>{{UserName}}</span>
            </div>
          </td>
          <td>
            <div class="user-info">
              {{#ifCond UserPermission "==" 0}}
              <span class="status admin">Admin</span>
              {{/ifCond}}
              {{#ifCond UserPermission "==" 1}}
              <span class="status teacher">Instructor</span>
              {{/ifCond}}
              {{#ifCond UserPermission "==" 2}}
              <span class="status student">Student</span>
              {{/ifCond}}
            </div>
          </td>
          <td>
            <a href="/admin/user/edit?id={{UserID}}" class="actions">
              <i class="bi bi-pencil" data-tooltip="Edit & View"></i>
            </a>
            <form action="/admin/user/del" method="POST" style="display:inline;">
              <input type="hidden" name="UserID" value="{{UserID}}">
              <button type="submit" class="actions"
                onclick="return confirm('Are you sure you want to delete {{UserName}} ?')">
                <i class="bi bi-trash" data-tooltip="Delete"></i>
              </button>
            </form>

          </td>
        </tr>
        {{/each}}
      </tbody>
    </table>
  </div>

</div>
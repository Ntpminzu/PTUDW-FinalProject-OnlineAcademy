{{#section "styles" append=true}}
<link rel="stylesheet" href="/detail.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
{{/section}}

<div class="CourseDetail">
  <div class="layout">
    <!-- Main Content -->
    <main class="main-content">
      <!-- Hero -->
      <section class="hero" style="background: url('{{course.ImageUrl}}') center center / cover no-repeat;">
        <div class="hero-overlay">
          <div class="course-stats">
            <div class="rating-info">
              <span class="average-rating">{{course.Rating}}</span>
              <div class="rating-stars">
                {{{renderStars course.Rating}}}
              </div>
              <span class="review-count">({{course.Total_Review}} reviews)</span>
            </div>
            <div class="enrollment-info">
              <i class="bi bi-person-fill"></i>
              <span>{{course.TotalStudent}} students enrolled</span>
            </div>
          </div>

          <!-- ✅ Button Container -->
          <div class="button-container">
            {{#if isInWishlist}}
            <form action="/account/wishlist/remove" method="post">
              <input type="hidden" name="courseId" value="{{course.CourseID}}">
              <button type="submit" class="magic-btn wishlist">
                <i class="bi bi-heart-fill"></i> Remove from Wishlist
              </button>
            </form>
            {{else}}
            <form action="/account/add-to-watchlist" method="post">
              <input type="hidden" name="courseId" value="{{course.CourseID}}">
              <button type="submit" class="magic-btn wishlist">
                <i class="bi bi-heart"></i> Add to Wishlist
              </button>
            </form>
            {{/if}}

            {{#unless isBought}}
            <form action="/account/buy-now" method="post">
              <input type="hidden" name="courseId" value="{{course.CourseID}}">
              <button type="submit" class="magic-btn start">
                <i class="bi bi-cart"></i> Buy Now
              </button>
            </form>
            {{/unless}}
          </div>
        </div>
      </section>

      <!-- Course Overview with Detailed Info -->
      <section class="overview mb-3">
        <div class="course-details-card">
          <h5 class="card-header">
            <i class="bi bi-book-half"></i> Course Details
          </h5>
          <div class="card-body">
            <h5 class="card-title">{{course.CourseName}}</h5>
            <p class="card-text">Description: {{{course.TinyDes}}}</p>
            <p class="card-text">Instructor: {{course.InstructorName}}</p>
            <p class="card-text">Duration: {{{course.TinyDes}}}</p>
            <p class="card-text">Level: {{course.Level}}</p>
            <p class="card-text">Prerequisites: Basic knowledge of programming and mathematics</p>
            <p class="card-text">What You'll Learn:
            <ul>
              <li>{{{course.FullDes}}}</li>
            </ul>
            </p>
            <p class="card-text">Benefits: Certificate upon completion, lifetime access, community support</p>
            <p class="card-text">Tuition Fee: ${{course.CurrentPrice}}</p>
            <p class="card-text">Last Updated: {{course.Date}}</p>

            {{#if isBought}}
            <a href="/course/enroll?id={{course.CourseID}}" class="magic-btn enroll">
              <i class="bi bi-journal-plus"></i> Enroll Now
            </a>
            {{/if}}
          </div>

          <div class="card-footer text-muted text-center">
            Hogwarts Academy © 2025
          </div>
        </div>

        <!-- Course Outline -->
        <div class="course-outline">
          <h3>Course Outline</h3>
          <ul class="outline-list">
            {{#each lessons}}
            <li>
              <img src="https://encrypted-tbn0.gstatic.com/images?q=tbnh=CCRDClx9UsQYMycysG6spxwOulfpKODkx2_ZA&s"
                alt="">
              <span>{{this.LessonName}}</span>
              <p>{{{this.TinyDes}}}</p>

              {{!-- Chỉ hiển thị preview cho bài đầu tiên --}}
              {{#if @first}}
              <button class="magic-btn secondary" onclick="togglePreview('lesson-{{this.LessonID}}')">Preview</button>
              <div id="lesson-{{this.LessonID}}" class="preview-content" style="display: none; text-align: center;">
                <h5>Content:</h5>
                <p>{{{this.FullDes}}}</p>
                <div style="margin: 0 auto; display: block; max-width: 600px;">
                  <iframe width="100%" height="340" src="{{this.VideoUrl}}" frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
                  </iframe>
                </div>
              </div>
              {{else}}
              <button class="magic-btn secondary" disabled>Preview Locked</button>
              {{/if}}
            </li>
            {{/each}}
          </ul>
        </div>
      </section>

      <!-- Related Courses -->
      <section class="related-courses">
        <h2>Related Courses in This Field</h2>
        <div class="related-courses-list">
          {{#each relatedCourses}}
          <div class="course-card">
            <img src="{{this.ImageUrl}}" alt="Course Thumbnail" class="course-thumbnail">
            <div class="course-info">
              <h4>{{this.CourseName}}</h4>
              <p class="course-instructor">By {{this.InstructorName}}</p>
              <div class="course-stats">
                <span class="course-rating">{{this.Rating}} <i class="bi bi-star-fill"></i> ({{this.Total_Review}}
                  reviews)</span>
                <span class="course-enrollment">{{this.TotalStudent}} students</span>
              </div>
              <p class="course-price">{{this.CurrentPrice}} <span class="original-price">{{this.OriginalPrice}}</span>
              </p>
              <a href="/course/detail?id={{this.CourseID}}" class="magic-btn course">View Course</a>
            </div>
          </div>
          {{/each}}
        </div>
      </section>

      <!-- Feedback Section -->
      <section class="feedback-section">
        <h2>Student Feedback</h2>
        <div class="feedback-list">
          {{#each feedbacks}}
          <div class="feedback-item">
            <div class="feedback-header">
              <span class="feedback-user">{{this.Fullname}}</span>
            </div>
            <p class="feedback-content">{{this.Feedback}}</p>
            <span class="feedback-date">{{this.created_at}}</span>
          </div>
          {{/each}}
        </div>
      </section>

      <!-- Comment Form Section -->
      {{#if canFeedback}}
      <section class="comment-form-section">
        <h2>Leave a Review</h2>
        <form action="/account/add-feedback" method="post">
          <input type="hidden" name="courseId" value="{{course.CourseID}}">
          <div class="mb-3">
            <label for="commentContent" class="form-label">Comment</label>
            <textarea class="form-control" id="commentContent" name="feedback" rows="3"></textarea>
          </div>
          <button type="submit" class="magic-btn secondary btn-sm">Submit</button>
        </form>
      </section>
      {{/if}}
    </main>
  </div>
</div>

<script>
  function togglePreview(lessonId) {
    const previewContent = document.getElementById(lessonId);
    previewContent.style.display =
      previewContent.style.display === "none" || previewContent.style.display === ""
        ? "block"
        : "none";
  }
</script>
<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hogwarts Academy Homepage</title>
  {{{_sections.styles}}}
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Swiper -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <link rel="stylesheet" href="/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Navbar CSS -->
  <link rel="stylesheet" href="/navbar.css">
  <!-- TinyMCE -->
  <script src="https://cdn.tiny.cloud/1/kars04ab2ueugpophlra5df3y4wx19okwc1dey6chtnkdw36/tinymce/7/tinymce.min.js"
    referrerpolicy="origin" crossorigin="anonymous"></script>
  <!-- Uppy -->
  <link href="https://releases.transloadit.com/uppy/v5.1.8/uppy.min.css" rel="stylesheet">
</head>

<body>
  <!-- ðŸŒŸ NAVBAR -->
  <header class="navbar">
    {{> navbar}}
  </header>

  {{{body}}}
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
    crossorigin="anonymous"></script>

  <script src="https://releases.transloadit.com/uppy/v3.23.0/uppy.min.js"></script>
  <script>
    // Biáº¿n toÃ n cá»¥c Ä‘á»ƒ theo dÃµi khá»Ÿi táº¡o TinyMCE cho tab "Add"
    let isTinyMCEInitialized = false;

    // --- HÃ€M 1: KHá»žI Táº O TINYMCE ---
    // HÃ m nÃ y sáº½ Ä‘Æ°á»£c gá»i vÃ o Ä‘Ãºng thá»i Ä‘iá»ƒm
    function initializeTinyMCE(selector) {
      if (typeof tinymce !== 'undefined') {
        tinymce.init({
          selector: 'textarea, textarea.wysiwyg-editor',
          plugins: [
            'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'link', 'lists', 'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
            'checklist', 'mediaembed', 'casechange', 'formatpainter', 'pageembed', 'a11ychecker', 'tinymcespellchecker', 'permanentpen', 'powerpaste', 'advtable', 'advcode', 'advtemplate', 'ai', 'uploadcare', 'mentions', 'tinycomments', 'tableofcontents', 'footnotes', 'mergetags', 'autocorrect', 'typography', 'inlinecss', 'markdown', 'importword', 'exportword', 'exportpdf'
          ],
          toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography uploadcare | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
          tinycomments_mode: 'embedded',
          tinycomments_author: 'Author name',
          mergetags_list: [
            { value: 'First.Name', title: 'First Name' },
            { value: 'Email', title: 'Email' },
          ],
          ai_request: (request, respondWith) => respondWith.string(() => Promise.reject('See docs to implement AI Assistant')),
          uploadcare_public_key: 'b33e273dc78492172054',
        });
      } else {
        console.error("Error: TinyMCE library not loaded yet.");
      }
    }

    // --- HÃ€M 2: CHUYá»‚N TAB (DÃ™NG CHUNG) ---
    function switchCourseTab(tabName) {
      document.querySelectorAll("#coursesSection .tab-btn").forEach(btn => btn.classList.remove("active"));
      document.querySelectorAll("#coursesSection .tab-content").forEach(content => content.classList.remove("active"));

      const activeButton = document.querySelector(`#coursesSection .tab-btn[data-tab='${tabName}']`);
      if (activeButton) activeButton.classList.add("active");

      const activeContent = document.getElementById("course" + tabName.charAt(0).toUpperCase() + tabName.slice(1) + "Tab");
      if (activeContent) activeContent.classList.add("active");

      // Logic khá»Ÿi táº¡o TinyMCE cho tab "Add" (khi báº¥m vÃ o)
      if (tabName === 'add' && !isTinyMCEInitialized) {
        initializeTinyMCE('#courseAddTab textarea.wysiwyg-editor');
        isTinyMCEInitialized = true; // ÄÃ¡nh dáº¥u Ä‘Ã£ khá»Ÿi táº¡o
      }
    }

    // --- HÃ€M 3: FILTER (DÃ™NG CHUNG) ---
    function filterCourseListClientSide() {
      const searchTerm = document.getElementById('courseSearchInputClient')?.value.toLowerCase() || '';
      const subCategoryFilter = document.getElementById('categoryFilterClient')?.value || '';
      const statusFilter = document.getElementById('statusFilterClient')?.value || '';
      const courseCards = document.querySelectorAll('.course-card-item');

      if (courseCards.length === 0) return;

      courseCards.forEach(card => {
        const courseName = card.querySelector('.course-name')?.textContent.toLowerCase() || '';
        const subCatId = card.getAttribute('data-subcatid');
        const status = card.getAttribute('data-status');
        const matchesSearch = !searchTerm || courseName.includes(searchTerm);
        const matchesSubCategory = !subCategoryFilter || subCatId === subCategoryFilter;
        const matchesStatus = !statusFilter || status === statusFilter;
        card.style.display = (matchesSearch && matchesSubCategory && matchesStatus) ? '' : 'none';
      });
    }

    // --- Sá»° KIá»†N CHÃNH: CHáº Y SAU KHI Má»ŒI THá»¨ (SCRIPT, CSS, áº¢NH) ÄÃƒ Táº¢I XONG ---
    window.addEventListener('load', () => {

      // 1. Khá»Ÿi táº¡o ngay láº­p tá»©c cho cÃ¡c editor TÄ¨NH
      // (Ãp dá»¥ng cho course-edit.hbs, lesson-form.hbs)
      initializeTinyMCE('textarea.wysiwyg-editor:not(#courseAddTab textarea.wysiwyg-editor)');

      // 2. Xá»­ lÃ½ logic cho trang course.hbs (trang cÃ³ tab)
      const listTabButton = document.querySelector("#coursesSection .tab-btn[data-tab='list']");
      if (listTabButton) {
        const urlParams = new URLSearchParams(window.location.search);
        const _errorAddStr = "{{#if errorAdd}}true{{else}}false{{/if}}";
        const errorAdd = (_errorAddStr === 'true');
        const addSuccess = urlParams.has('addSuccess');
        const updateSuccess = urlParams.has('updateSuccess');
        const deleteSuccess = urlParams.has('deleteSuccess');
        const requestedTab = "{{activeTab}}";

        let activeDefaultTab = 'list';
        if (requestedTab === 'add' || errorAdd) {
          activeDefaultTab = 'add';
        }

        // Gá»i hÃ m switchTab (sáº½ tá»± Ä‘á»™ng init TinyMCE náº¿u lÃ  tab 'add')
        switchCourseTab(activeDefaultTab);

        // Hiá»ƒn thá»‹ thÃ´ng bÃ¡o thÃ nh cÃ´ng (logic nÃ y Ä‘Ã£ Ä‘Ãºng)
        let successMessage = '';
        if (addSuccess) successMessage = 'ThÃªm khÃ³a há»c thÃ nh cÃ´ng!';
        else if (updateSuccess) successMessage = 'Cáº­p nháº­t khÃ³a há»c thÃ nh cÃ´ng!';
        else if (deleteSuccess) successMessage = 'XÃ³a khÃ³a há»c thÃ nh cÃ´ng!';

        if (successMessage) {
          const listTab = document.getElementById('courseListTab');
          if (listTab) {
            const successMsg = document.createElement('div');
            successMsg.className = 'alert alert-success';
            successMsg.setAttribute('role', 'alert');
            successMsg.style = "background-color: #27ae60; color: white; border: none; margin: 0 auto 20px auto; max-width: 900px; text-align: center; font-weight: bold;";
            successMsg.textContent = successMessage;
            listTab.insertBefore(successMsg, listTab.querySelector('.search-filter-bar'));
            setTimeout(() => successMsg.remove(), 4000);
          }
        }
      }

      // HÃ m trá»£ giÃºp khá»Ÿi táº¡o Uppy
      function initUppy(containerId, inputId, allowedFileTypes, note) {
        const uppyContainer = document.getElementById(containerId);
        const targetInput = document.getElementById(inputId);

        // Chá»‰ khá»Ÿi táº¡o náº¿u cáº£ 2 pháº§n tá»­ tá»“n táº¡i trÃªn trang
        if (uppyContainer && targetInput && typeof Uppy !== 'undefined') {
          // Láº¥y Uppy tá»« window (vÃ¬ dÃ¹ng UMD build)
          const { Uppy, Dashboard, XHRUpload } = window.Uppy;

          const uppy = new Uppy({
            autoProceed: true, // Tá»± Ä‘á»™ng upload
            restrictions: {
              maxNumberOfFiles: 1,
              allowedFileTypes: allowedFileTypes // ['image/*'] hoáº·c ['video/*']
            }
          });

          uppy.use(Dashboard, {
            target: uppyContainer,
            inline: true,
            height: 250,
            width: '100%',
            note: note,
            proudlyDisplayPoweredByUppy: false,
            showProgressDetails: true
          });

          uppy.use(XHRUpload, {
            endpoint: '/management/upload', // Route backend chÃºng ta Ä‘Ã£ táº¡o
            fieldName: 'file', // Pháº£i khá»›p vá»›i upload.single('file')
            // headers: { 'X-CSRF-Token': '...' } // ThÃªm náº¿u cáº§n CSRF
          });

          // Khi upload thÃ nh cÃ´ng
          uppy.on('upload-success', (file, response) => {
            if (response.body.uploadURL) {
              // GÃ¡n Ä‘Æ°á»ng dáº«n URL tráº£ vá» tá»« server vÃ o input
              targetInput.value = response.body.uploadURL;
              console.log('Upload thÃ nh cÃ´ng:', response.body.uploadURL);
            }
          });

          uppy.on('complete', (result) => {
            console.log('Upload complete! Files:', result.successful);
          });

          uppy.on('error', (error) => {
            console.error('Lá»—i Uppy:', error);
          });
        }
      }

      // Khá»Ÿi táº¡o Uppy cho Image (trÃªn trang Add Course)
      initUppy('uppy-image-add', 'ImageUrlInput_Add', ['image/*'], 'Chá»‰ upload 1 áº£nh (JPG, PNG, WEBP...)');

      // Khá»Ÿi táº¡o Uppy cho Image (trÃªn trang Edit Course)
      initUppy('uppy-image-edit', 'ImageUrlInput_Edit', ['image/*'], 'Chá»‰ upload 1 áº£nh (JPG, PNG, WEBP...)');

      // Khá»Ÿi táº¡o Uppy cho Video (trÃªn trang Lesson Form)
      initUppy('uppy-video', 'VideoUrlInput', ['video/*', 'audio/*'], 'Upload 1 file video (MP4, WEBM...) hoáº·c audio (MP3...)');

    });
  </script>
</body>

</html>
{{#section "styles" append=true}}
<link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
<link rel="stylesheet" href="/enroll.css">
{{/section}}

<div class="course-page container mt-4">
  <div class="card course-header">
    <h5 class="card-header">
      <i class="bi bi-book-half"></i> Course Details
    </h5>
    <div class="card-body">
      <h5 class="card-title">{{course.CourseName}}</h5>
      <p class="card-text">Description: {{course.CourseName}}</p>
      <p class="card-text">Professor: {{course.InstructorName}}</p>
      <p class="card-text">Duration: {{course.WeekView}} weeks</p>
      <a href="/course/detail?id={{course.CourseID}}" class="btn-return">
        <i class="bi bi-arrow-left"></i> Return to Course List
      </a>
    </div>
  </div>

  <!-- Video List -->
  <div class="video-list mt-4">
    <h5>Course Modules</h5>
    <ul class="list-group" id="videoList">
      {{#each lessons}}
      <li class="list-group-item video-item" data-video="/LessonVid/{{this.VideoUrl}}" data-lesson-id="{{this.LessonID}}"
        data-course-id="{{../course.CourseID}}">
        <i class="bi bi-play-circle"></i>
        {{this.LessonName}}
        {{#if this.isCompleted}}
        <i class="bi bi-check-circle-fill" style="color: #28a745; margin-left: 10px;"></i>
        {{/if}}
      </li>
      {{/each}}
    </ul>
  </div>

  <!-- Video Player -->
  <div class="video-player mt-4" id="videoSection" style="visibility: hidden; height: 0;">
    <h5>Now Playing: <span id="videoTitle"></span></h5>
    <video id="videoPlayer" class="plyr" playsinline controls>
      <source src="" type="video/mp4" />
      Your browser does not support HTML5 video.
    </video>
  </div>
</div>

<script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ================== ‚öôÔ∏è C·∫§U H√åNH PLAYER ==================
  const player = new Plyr("#videoPlayer", {
    controls: [
      'play-large', 'play', 'progress', 'current-time',
      'mute', 'volume', 'settings', 'fullscreen'
    ]
  });

  // ================== üß© BI·∫æN TO√ÄN C·ª§C ==================
  const videoItems = document.querySelectorAll(".video-item");
  const videoTitle = document.getElementById("videoTitle");
  const videoSection = document.getElementById("videoSection");

  // ·∫®n player khi m·ªõi load
  videoSection.style.visibility = "hidden";
  videoSection.style.height = "0";
  videoSection.style.overflow = "hidden";

  const courseId = videoItems[0]?.getAttribute("data-course-id");
  const courseKey = `course_${courseId}_progress`;
  let learnedLessons = JSON.parse(localStorage.getItem(courseKey)) || [];
  let currentIndex = -1;

  // ================== ‚ñ∂Ô∏è H√ÄM PH√ÅT VIDEO ==================
  function playVideoAtIndex(index) {
    if (index < 0 || index >= videoItems.length) return;
    videoItems.forEach(v => v.classList.remove("active"));
    const item = videoItems[index];
    item.classList.add("active");

    const videoUrl = item.getAttribute("data-video");
    const title = item.textContent.trim();

    // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ v√† hi·ªÉn th·ªã player
    videoTitle.textContent = title;
    videoSection.style.visibility = "visible";
    videoSection.style.height = "auto";

    // C·∫≠p nh·∫≠t ngu·ªìn video
    const source = document.querySelector("#videoPlayer source");
    source.src = videoUrl;
    player.media.load();
    player.play();

    currentIndex = index;
  }

  // ================== üìä GHI LOG TI·∫æN TR√åNH ==================
  function logProgress(lessonId, total, done) {
    console.group("üéì COURSE PROGRESS LOG");
    console.log("‚úÖ Lesson done:", lessonId);
    console.log("üìö Course ID:", courseId);
    console.log("üìñ Total lessons:", total);
    console.log("üìà Completed:", done);
    console.log("üíæ LocalStorage key:", courseKey);
    console.log("üß© Learned lessons:", learnedLessons);
    console.groupEnd();
  }

  // ================== üñ±Ô∏è S·ª∞ KI·ªÜN CLICK ==================
  videoItems.forEach((item, index) => {
    item.addEventListener("click", () => playVideoAtIndex(index));
  });

  // ================== üé• KHI VIDEO K·∫æT TH√öC ==================
  player.on("ended", async () => {
    if (currentIndex === -1) return;

    const currentItem = videoItems[currentIndex];
    const lessonId = currentItem.getAttribute("data-lesson-id");

    if (!learnedLessons.includes(lessonId)) {
      learnedLessons.push(lessonId);
      localStorage.setItem(courseKey, JSON.stringify(learnedLessons));
    }

    const totalLessons = videoItems.length;
    const completedLessons = learnedLessons.length;
    logProgress(lessonId, totalLessons, completedLessons);

    try {
      const resLesson = await fetch('/account/finish-lesson', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ lessonId, courseId })
      });

      if (!resLesson.ok) throw new Error("‚ùå Failed to finish lesson");
      console.log("‚úÖ Lesson finished successfully");

      if (completedLessons >= totalLessons) {
        const resCourse = await fetch('/account/finish-course', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ courseId })
        });
        if (resCourse.ok) alert("üéâ Congratulations! You‚Äôve completed this course!");
      }

      setTimeout(() => window.location.reload(), 1500);
    } catch (err) {
      console.error("‚ö†Ô∏è Error:", err);
      setTimeout(() => window.location.reload(), 1500);
    }
  });
});
</script>
